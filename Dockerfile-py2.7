FROM fredrikaverpil/vfxplatform

RUN yum update -y && \
    yum install -y \
        Xvfb \
        mesa-dri-drivers \
        libxkbcommon \
        libxkbcommon-devel \
        libxkbcommon-x11 \
        libxkbcommon-x11-devel \
        python-pyside

# PyQt4
# The specific PyQt4 version needs to be compatible with the same SIP used by PyQt5 (in this case SIP 4.18)
ENV PYQT4_VER=4.11.4
RUN wget http://sourceforge.net/projects/pyqt/files/PyQt4/PyQt-${PYQT4_VER}/PyQt-x11-gpl-${PYQT4_VER}.tar.gz && \
    tar -xvf PyQt-x11-gpl-${PYQT4_VER}.tar.gz && \
    cd PyQt-x11-gpl-${PYQT4_VER} && \
    /usr/local/python/bin/python2.7 configure.py \
        # --verbose \
        --confirm-license \
        --qmake=/usr/local/Qt-${QT_VER}/bin/qmake && \
    make && \
    make install && \
    cd .. && rm -rf PyQt-x11-gpl-${PYQT4_VER}

# Nose is the Python test-runner
RUN /usr/local/python/bin/pip2.7 install \
    nose \
    nosepipe \
    six

# Enable additional output from Qt.py
ENV QT_VERBOSE true
ENV QT_TESTING true

# Xvfb
ENV DISPLAY :99

# Prevent error: "Qt: Failed to create XKB context!"
# https://lists.debian.org/debian-backports/2014/10/msg00061.html
ENV QT_XKB_CONFIG_ROOT=/usr/share/X11/xkb

# Warnings are exceptions
ENV PYTHONWARNINGS="ignore"

WORKDIR /workspace/Qt.py

RUN cp -avr /usr/lib64/python2.7/site-packages/shiboken* /usr/local/python/lib/python2.7/site-packages && \
    cp -avr /usr/lib64/python2.7/site-packages/PySide /usr/local/python/lib/python2.7/site-packages

# Experimental (could break things)
# Replace python and python2.7 with our custom build of Python
ENV PATH="/usr/local/python/bin:${PATH}"
RUN ln -s /usr/local/python/bin/python2.7 /usr/local/python/bin/python

ENTRYPOINT cp -r /Qt.py /workspace && \
    Xvfb :99 -screen 0 1024x768x16 2>/dev/null & \
    while ! ps aux | grep -q '[0]:00 Xvfb :99 -screen 0 1024x768x16'; \
        do echo "Waiting for Xvfb..."; sleep 1; done && \
    echo "#\n# Testing implementation.." && \
        python -u run_tests.py && \
    echo "#\n# Testing caveats..\n#"  && \
        python build_caveats.py && \
        nosetests \
            --verbose \
            --with-doctest \
            --with-process-isolation \
            test_caveats.py && \
    echo "#\n# Testing membership..\n#" && \
        python build_membership.py && \
        nosetests \
            --verbose \
            test_membership.py && \
    echo "#\n# Testing examples..\n#" && \
        nosetests \
        --verbose \
        --with-process-isolation \
        --with-doctest \
        --exe \
            examples/*/*.py && \
    echo Done
